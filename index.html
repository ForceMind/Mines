<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>æ‰¾åœ°é›·</title>
<style>
  :root{
    /* è°ƒäº®åçš„é…è‰² */
    --bg1:#0e1f3a;
    --bg2:#15365f;
    --panel:#102747;
    --panel2:#16385f;
    --accent:#22d3ee;   /* é’è‰²æ›´äº® */
    --warn:#f87171;     /* çº¢æ›´äº® */
    --text:#f3f4f6;
    --muted:#c7d2fe;
    --btn:#1e3a8a;
    --btn2:#25469e;
    --grid:#0f2444;
    --safe:#38bdf8;
    --mine:#ef4444;
    --gold:#fde68a;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2) 50%,var(--bg1));
    color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
    min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;
  }
  .app{width:100%;max-width:1100px;display:grid;grid-template-columns:340px 1fr;gap:16px}
  @media (max-width:900px){.app{grid-template-columns:1fr}}
  .card{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .panel{padding:16px 16px 12px}
  h1{margin:0 0 12px;font-size:20px;letter-spacing:.2px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
  label{font-size:12px;color:var(--gold)}
  select,input{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
  input[type="number"]{width:120px}
  .btn{
    background:var(--btn);border:1px solid rgba(255,255,255,.2);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;transition:.15s;
    user-select:none;box-shadow:0 4px 10px rgba(30,58,138,.35)
  }
  .btn:hover{transform:translateY(-1px)}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
  .btn-primary{background:linear-gradient(180deg,#1fb6ff,#1d4ed8)}
  .btn-danger{background:linear-gradient(180deg,#ef4444,#b91c1c)}
  .btn-gold{background:linear-gradient(180deg,#fde68a,#f59e0b);color:#1f2937}
  .balance{
    display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.04);
    border-top:1px solid rgba(255,255,255,.12);padding:12px 16px;border-radius:0 0 16px 16px
  }
  .balance strong{color:var(--gold);font-size:18px;text-shadow:0 0 8px rgba(253,230,138,.35)}
  .gridWrap{padding:16px}
  .grid{
    display:grid;gap:8px;justify-content:center;align-content:center;padding:12px;background:linear-gradient(180deg,#0b1d3a,#0f2b55);
    border-radius:12px;border:1px solid rgba(255,255,255,.12);min-height:420px
  }
  .cell{
    width:52px;height:52px;display:flex;align-items:center;justify-content:center;
    background:radial-gradient(100% 100% at 50% 0%, #2a4f8c 0%, #1a3766 100%);
    border:1px solid rgba(255,255,255,.18);border-radius:10px;cursor:pointer;user-select:none;
    font-weight:800;font-size:16px;color:#e0f2fe;box-shadow:inset 0 1px 0 rgba(255,255,255,.25), 0 6px 14px rgba(0,0,0,.25);
    transition:transform .08s ease, background .2s, border-color .2s;
  }
  .cell:hover{transform:translateY(-2px)}
  .cell.revealed{cursor:default;background:#19406f;border-color:rgba(255,255,255,.3);color:#c7d2fe}
  .cell.mine{background:#7f1d1d;border-color:#fecaca;color:#fecaca}
  .stats{
    display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:12px 16px;border-top:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.04);border-radius:0 0 16px 16px
  }
  .statBox{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:10px}
  .statLabel{font-size:12px;color:#bbf7d0}
  .statValue{font-size:18px;margin-top:6px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .log{padding:10px 16px;border-top:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);max-height:160px;overflow:auto;border-radius:0 0 16px 16px}
  .log p{margin:6px 0;color:#e5e7eb;font-size:13px}
  .tip{color:#d1fae5;font-size:12px;margin-top:4px}
</style>
</head>
<body>
<div class="app">
  <!-- å·¦ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
  <div class="card">
    <div class="panel">
      <h1>æ‰¾åœ°é›·ï½œå¯æ’¤é€€</h1>
      <div class="row">
        <div>
          <label>æ£‹ç›˜å¤§å°</label><br>
          <select id="boardSize">
            <option value="4">4 Ã— 4</option>
            <option value="5">5 Ã— 5</option>
            <option value="6">6 Ã— 6</option>
            <option value="8" selected>8 Ã— 8</option>
          </select>
        </div>
        <div>
          <label>åœ°é›·æ•°é‡</label><br>
          <input id="mineCount" type="number" value="10" min="1" step="1">
        </div>
        <div>
          <label>ä¸‹æ³¨é‡‘é¢</label><br>
          <input id="betAmount" type="number" value="10" min="1" step="1">
        </div>
      </div>
      <div class="toolbar">
        <button id="startBtn" class="btn btn-primary">å¼€å§‹æ¸¸æˆï¼ˆæ‰£æ¬¾ï¼‰</button>
        <button id="cashoutBtn" class="btn btn-gold" disabled>æ’¤é€€å¹¶ç»“ç®—</button>
        <button id="resetBtn" class="btn">æœ¬å±€é‡å¼€</button>
      </div>
      <div class="tip">
        è¯´æ˜ï¼šæ’¤é€€å¥–é‡‘ = <b>ä¸‹æ³¨é‡‘é¢ Ã— 0.97 Ã· å½“å‰â€œä¸‹ä¸€æ ¼å®‰å…¨æ¦‚ç‡â€</b>ã€‚  
        ï¼ˆä¸‹ä¸€æ ¼å®‰å…¨æ¦‚ç‡ = ä»æœªæ‰“å¼€å®‰å…¨æ ¼æ•° Ã· ä»æœªæ‰“å¼€æ€»æ ¼å­æ•°ï¼‰
      </div>
    </div>
    <div class="stats">
      <div class="statBox">
        <div class="statLabel">å·²å®‰å…¨ç‚¹å‡» (k)</div>
        <div class="statValue" id="safeClicks">0</div>
      </div>
      <div class="statBox">
        <div class="statLabel">ä¸‹ä¸€æ ¼å®‰å…¨æ¦‚ç‡</div>
        <div class="statValue" id="nextProb">â€”</div>
      </div>
      <div class="statBox">
        <div class="statLabel">å½“å‰å¯æ’¤é€€å¥–é‡‘</div>
        <div class="statValue" id="cashoutValue">â€”</div>
      </div>
    </div>
    <div class="balance">
      <div>ä½™é¢</div>
      <div>
        <strong id="balanceText">1000.00</strong>
        <button id="add100" class="btn" style="margin-left:8px;">+100</button>
      </div>
    </div>
    <div class="log" id="log"></div>
  </div>

  <!-- å³ä¾§ï¼šæ£‹ç›˜ -->
  <div class="card gridWrap">
    <div id="grid" class="grid"></div>
  </div>
</div>

<script>
(function(){
  // ------- çŠ¶æ€ -------
  let N = 8, M = 10;                    // N*N æ€»æ ¼å­ï¼›M åœ°é›·æ•°
  let mines = new Set();                 // åœ°é›·ä½ç½®é›†åˆï¼ˆç´¢å¼•ï¼‰
  let revealed = new Set();              // å·²æ­ç¤ºå®‰å…¨æ ¼ï¼ˆç´¢å¼•ï¼‰
  let gameActive = false;                // æ˜¯å¦è¿›è¡Œä¸­
  let exploded = false;                  // æ˜¯å¦å·²è§¦é›·
  let bet = 10;                          // æœ¬å±€ä¸‹æ³¨
  let balance = 1000;                    // ä½™é¢
  let gridEl = document.getElementById('grid');

  const boardSizeEl = document.getElementById('boardSize');
  const mineCountEl = document.getElementById('mineCount');
  const betAmountEl = document.getElementById('betAmount');
  const startBtn = document.getElementById('startBtn');
  const cashoutBtn = document.getElementById('cashoutBtn');
  const resetBtn = document.getElementById('resetBtn');
  const add100Btn = document.getElementById('add100');

  const safeClicksEl = document.getElementById('safeClicks');
  const nextProbEl = document.getElementById('nextProb');
  const cashoutValueEl = document.getElementById('cashoutValue');
  const balanceText = document.getElementById('balanceText');
  const logEl = document.getElementById('log');

  // ------- å·¥å…·å‡½æ•° -------
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const formatMoney = (x)=> (+x).toFixed(2);
  const log = (msg)=>{ const p=document.createElement('p'); p.textContent=msg; logEl.prepend(p); while(logEl.children.length>60) logEl.removeChild(logEl.lastChild); };

  function updateHUD(){
    const total = N*N;
    const opened = revealed.size; // åªç»Ÿè®¡å®‰å…¨æ ¼
    const remainCells = total - opened;             // ä»æœªæ‰“å¼€çš„æ€»æ ¼å­ï¼ˆå«é›·ä¸æœªå¼€çš„å®‰å…¨æ ¼ï¼‰
    const remainSafe  = (total - M) - opened;       // ä»æœªæ‰“å¼€çš„å®‰å…¨æ ¼
    if(gameActive && !exploded){
      const nextP = remainCells>0 ? remainSafe/remainCells : 0;
      nextProbEl.textContent = (nextP*100).toFixed(2) + '%';
      const k = revealed.size;
      if(k>0 && nextP>0){
        const cash = bet * 0.97 / nextP;            // æ–°å…¬å¼ï¼šbet / p_safe * 0.97
        cashoutValueEl.textContent = formatMoney(cash);
        cashoutBtn.disabled = false;
      }else{
        cashoutValueEl.textContent = 'â€”';
        cashoutBtn.disabled = true;
      }
    }else{
      nextProbEl.textContent = 'â€”';
      cashoutValueEl.textContent = 'â€”';
      cashoutBtn.disabled = true;
    }
    balanceText.textContent = formatMoney(balance);
    safeClicksEl.textContent = revealed.size;
  }

  function buildGrid(){
    gridEl.innerHTML = '';
    gridEl.style.gridTemplateColumns = `repeat(${N}, minmax(40px, 52px))`;
    gridEl.style.minHeight = (N<8?380:420)+'px';
    for(let i=0;i<N*N;i++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.idx = i;
      cell.addEventListener('click', onCellClick, {once:false});
      gridEl.appendChild(cell);
    }
  }

  function placeMines(){
    mines.clear();
    const total = N*N;
    while(mines.size < M){
      mines.add(Math.floor(Math.random()*total));
    }
  }

  function neighbors(idx){
    const x = idx % N, y = Math.floor(idx/N);
    const res=[];
    for(let dy=-1;dy<=1;dy++){
      for(let dx=-1;dx<=1;dx++){
        if(dx===0 && dy===0) continue;
        const nx=x+dx, ny=y+dy;
        if(nx>=0 && nx<N && ny>=0 && ny<N){ res.push(ny*N + nx); }
      }
    }
    return res;
  }

  function countAdjMines(idx){
    return neighbors(idx).reduce((acc,i)=>acc + (mines.has(i)?1:0), 0);
  }

  function reveal(idx){
    if(revealed.has(idx)) return;
    const el = gridEl.children[idx];
    if(!el) return;
    revealed.add(idx);
    const n = countAdjMines(idx);
    el.classList.add('revealed');
    el.textContent = n>0 ? n : '';
    el.style.color = n===0 ? '#e0f2fe' : '#bbf7d0';
  }

  function revealAllMines(){
    mines.forEach(i=>{
      const el = gridEl.children[i];
      if(el){
        el.classList.add('revealed','mine');
        el.textContent = 'ğŸ’£';
      }
    });
  }

  function onCellClick(e){
    if(!gameActive || exploded) return;
    const idx = +e.currentTarget.dataset.idx;
    if(revealed.has(idx)) return;

    // è®¡ç®—â€œæœ¬æ¬¡ç‚¹å‡»å‰â€çš„å½“ç›˜å®‰å…¨æ¦‚ç‡ï¼ˆç”¨äºèƒœåˆ©è‡ªåŠ¨ç»“ç®—ï¼‰
    const total = N*N;
    const openedBefore = revealed.size;
    const remainCellsBefore = total - openedBefore;
    const remainSafeBefore  = (total - M) - openedBefore;
    const pBefore = remainCellsBefore>0 ? (remainSafeBefore/remainCellsBefore) : 0;
    const payoutIfWinThisClick = (openedBefore>=0 && pBefore>0) ? bet * 0.97 / pBefore : 0;

    if(mines.has(idx)){
      // è§¦é›·
      exploded = true;
      revealAllMines();
      e.currentTarget.classList.add('mine');
      e.currentTarget.textContent = 'ğŸ’¥';
      log(`ğŸ’¥ è§¦å‘åœ°é›·ï¼æœ¬å±€å¤±å» ${formatMoney(bet)}ã€‚`);
      gameActive = false;
      updateHUD();
      return;
    }

    // å®‰å…¨
    reveal(idx);

    // èƒœåˆ©æ¡ä»¶ï¼ˆå…¨éƒ¨å®‰å…¨æ ¼å¼€å®Œï¼‰
    const totalSafe = total - M;
    if(revealed.size >= totalSafe){
      balance += payoutIfWinThisClick; // ä½¿ç”¨â€œæœ¬æ¬¡ç‚¹å‡»å‰â€çš„å½“ç›˜æ¦‚ç‡ç»“ç®—
      log(`ğŸ† å…¨éƒ¨å®‰å…¨æ ¼å·²æ­ç¤ºï¼è‡ªåŠ¨ç»“ç®—åˆ°æ‰‹ ${formatMoney(payoutIfWinThisClick)}ï¼ˆæŒ‰æœ€åä¸€æ¬¡ç‚¹å‡»å‰çš„å½“ç›˜æ¦‚ç‡ï¼‰ã€‚`);
      gameActive = false;
      revealAllMines();
      updateHUD();
      return;
    }

    updateHUD();
  }

  // ------- äº¤äº’ -------
  function validateSettings(){
    N = parseInt(boardSizeEl.value, 10);
    const total = N*N;
    let m = parseInt(mineCountEl.value, 10);
    if(Number.isNaN(m)) m = 1;
    m = clamp(m, 1, total-1);
    mineCountEl.value = m;
    M = m;

    let b = parseFloat(betAmountEl.value);
    if(Number.isNaN(b) || b<=0) b = 1;
    b = Math.floor(b*100)/100;
    betAmountEl.value = b;
    bet = b;
  }

  function resetRound(keepBalance=true){
    gameActive = false;
    exploded = false;
    mines.clear();
    revealed.clear();
    if(!keepBalance){ balance = 1000; }
    buildGrid();
    updateHUD();
  }

  startBtn.addEventListener('click', ()=>{
    if(gameActive){
      log('âš ï¸ æœ¬å±€å·²åœ¨è¿›è¡Œä¸­ã€‚');
      return;
    }
    validateSettings();
    if(bet > balance){
      log('âš ï¸ ä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼æˆ–é™ä½ä¸‹æ³¨é‡‘é¢ã€‚');
      return;
    }
    balance -= bet;
    resetRound(true);
    validateSettings();
    placeMines();
    gameActive = true;
    exploded = false;
    log(`ğŸ® å¼€å§‹æ–°å±€ï¼š${N}Ã—${N}ï¼Œåœ°é›· ${M}ï¼Œä¸‹æ³¨ ${formatMoney(bet)}ï¼ˆå·²æ‰£æ¬¾ï¼‰ã€‚ç¥ä½ å¥½è¿ï¼`);
    updateHUD();
  });

  cashoutBtn.addEventListener('click', ()=>{
    if(!gameActive || exploded) return;
    const total = N*N;
    const opened = revealed.size;
    const remainCells = total - opened;
    const remainSafe  = (total - M) - opened;
    if(opened<=0){
      log('â„¹ï¸ å°šæœªç‚¹å‡»å®‰å…¨æ ¼ï¼Œæ— æ³•æ’¤é€€ç»“ç®—ã€‚');
      return;
    }
    if(remainSafe<=0 || remainCells<=0){
      log('â„¹ï¸ å½“å‰æ— æ³•æŒ‰å½“ç›˜æ¦‚ç‡ç»“ç®—ã€‚');
      return;
    }
    const nextP = remainSafe/remainCells;
    const payout = bet * 0.97 / nextP;
    balance += payout;
    log(`ğŸ’° æ’¤é€€æˆåŠŸï¼šå½“å‰ä¸‹ä¸€æ ¼å®‰å…¨æ¦‚ç‡ ${(nextP*100).toFixed(2)}%ï¼Œåˆ°æ‰‹ ${formatMoney(payout)}ã€‚`);
    gameActive = false;
    revealAllMines();
    updateHUD();
  });

  resetBtn.addEventListener('click', ()=>{
    resetRound(true);
    log('ğŸ”„ æœ¬å±€å·²é‡ç½®ï¼ˆä¸å½±å“ä½™é¢ï¼‰ã€‚');
  });

  add100Btn.addEventListener('click', ()=>{
    balance += 100;
    updateHUD();
    log('ğŸ’³ å·²å……å€¼ +100ã€‚');
  });

  boardSizeEl.addEventListener('change', ()=>{
    validateSettings();
    resetRound(true);
    log(`ğŸ§© æ£‹ç›˜åˆ‡æ¢ä¸º ${N}Ã—${N}ï¼Œè¯·è®¾ç½®åœ°é›·ä¸ä¸‹æ³¨åå¼€å§‹ã€‚`);
  });

  mineCountEl.addEventListener('change', ()=>{
    validateSettings();
    if(gameActive){
      log('âš ï¸ è¿›è¡Œä¸­çš„å¯¹å±€æ— æ³•ä¿®æ”¹åœ°é›·æ•°ã€‚è¯·é‡å¼€æœ¬å±€ã€‚');
      mineCountEl.value = M;
      return;
    }
    resetRound(true);
    log(`ğŸ§¨ åœ°é›·æ•°é‡å·²è®¾ä¸º ${M}ã€‚`);
  });

  betAmountEl.addEventListener('change', ()=>{
    validateSettings();
    if(gameActive){
      log('â„¹ï¸ æœ¬å±€ä¸‹æ³¨å·²ç”Ÿæ•ˆï¼Œä¿®æ”¹å°†åœ¨ä¸‹ä¸€å±€å¼€å§‹æ—¶ç”Ÿæ•ˆã€‚');
    }else{
      log(`ğŸ’µ ä¸‹æ³¨é‡‘é¢è®¾ä¸º ${formatMoney(bet)}ã€‚`);
    }
  });

  // åˆå§‹
  validateSettings();
  resetRound(true);
  log('ğŸ“Œ è§„åˆ™ï¼šç‚¹å‡»å®‰å…¨æ ¼å¯ç»§ç»­ï¼Œåœ¨æœªè§¦é›·æ—¶éšæ—¶æ’¤é€€ã€‚æ’¤é€€å¥–é‡‘ = ä¸‹æ³¨ Ã— 0.97 Ã· å½“å‰â€œä¸‹ä¸€æ ¼å®‰å…¨æ¦‚ç‡â€ã€‚');
})();
</script>
</body>
</html>
