<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>æ‰¾åœ°é›·ï½œå¯æ’¤é€€ç‰ˆ</title>
<style>
  :root{
    --bg1:#0e1f3a; --bg2:#15365f; --panel:#102747; --panel2:#16385f;
    --accent:#22d3ee; --warn:#f87171; --text:#f3f4f6; --muted:#c7d2fe;
    --btn:#1e3a8a; --btn2:#25469e; --safe:#38bdf8; --mine:#ef4444; --gold:#fde68a;
    --ink:#0f172a; --ink2:#1f2937;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2) 50%,var(--bg1));
    color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
    min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;
  }
  .app{width:100%;max-width:1100px;display:grid;grid-template-columns:340px 1fr;gap:16px}
  @media (max-width:900px){.app{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .panel{padding:16px 16px 12px}
  h1{margin:0 0 12px;font-size:20px;letter-spacing:.2px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
  label{font-size:12px;color:var(--gold)}

  /* â€”â€” è¾“å…¥æ§ä»¶ï¼ˆæµ…åº•æ·±å­—ï¼‰ â€”â€” */
  .select, .num, .money{
    background:#ffffff;color:var(--ink);border:1px solid #cbd5e1;border-radius:10px;
    padding:10px 12px;outline:none;
  }
  .select{appearance:none;position:relative;padding-right:34px;min-width:120px}
  .selectWrap{position:relative;display:inline-block}
  .selectWrap::after{
    content:"â–¾";position:absolute;right:10px;top:50%;transform:translateY(-50%);
    color:var(--ink2);pointer-events:none;font-size:12px;
  }
  .num{width:110px;text-align:center}
  .money{width:120px}

  .stepper{
    display:inline-flex;align-items:center;border-radius:10px;overflow:hidden;border:1px solid #cbd5e1;background:#fff;
  }
  .stepper button{
    background:#f1f5f9;border:none;padding:10px 12px;cursor:pointer;font-weight:700;color:var(--ink2);
    transition:transform .06s ease, filter .06s ease;
  }
  .stepper button:hover{filter:brightness(0.95)}
  .stepper button:active{transform:translateY(1px)}
  .stepper input{border:none;border-left:1px solid #e5e7eb;border-right:1px solid #e5e7eb}

  /* â€”â€” æŒ‰é’®åŠ¨æ•ˆ â€”â€” */
  .btn{
    background:var(--btn);border:1px solid rgba(255,255,255,.2);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;
    transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
    user-select:none;box-shadow:0 6px 14px rgba(30,58,138,.35)
  }
  .btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(30,58,138,.45)}
  .btn:active{transform:translateY(0);filter:brightness(0.95)}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}
  .btn-primary{background:linear-gradient(180deg,#1fb6ff,#1d4ed8)}
  .btn-gold{background:linear-gradient(180deg,#fde68a,#f59e0b);color:#1f2937}
  .btn-icon{
    width:36px;height:36px;border-radius:999px;border:1px solid rgba(255,255,255,.25);
    background:linear-gradient(180deg,#fef3c7,#fde68a);color:#1f2937;font-weight:900;cursor:pointer;
    transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
  }
  .btn-icon:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,.25)}
  .btn-icon:active{transform:translateY(0);filter:brightness(0.95)}

  .balance{
    display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.04);
    border-top:1px solid rgba(255,255,255,.12);padding:12px 16px;border-radius:0 0 16px 16px
  }
  .balance strong{color:var(--gold);font-size:18px;text-shadow:0 0 8px rgba(253,230,138,.35)}

  .gridWrap{padding:16px}
  .grid{
    display:grid;gap:8px;justify-content:center;align-content:center;padding:12px;
    background:linear-gradient(180deg,#0b1d3a,#0f2b55);border-radius:12px;border:1px solid rgba(255,255,255,.12);
    min-height:420px
  }

  /* â€”â€” æ£‹ç›˜æ ¼ + åŠ¨æ•ˆ â€”â€” */
  .cell{
    width:52px;height:52px;display:flex;align-items:center;justify-content:center;
    background:radial-gradient(100% 100% at 50% 0%, #2a4f8c 0%, #1a3766 100%);
    border:1px solid rgba(255,255,255,.18);border-radius:10px;cursor:pointer;user-select:none;
    transition:transform .08s ease, background .2s, border-color .2s, box-shadow .2s;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.15), 0 6px 14px rgba(0,0,0,.25);
    position:relative;overflow:hidden;
  }
  .cell:hover{transform:translateY(-2px)}
  .cell:active{transform:translateY(0);filter:brightness(0.98)}
  .cell.revealed{cursor:default;background:#19406f;border-color:rgba(255,255,255,.3)}
  .cell.mine{background:#7f1d1d;border-color:#fecaca;color:#fecaca}

  /* å®‰å…¨æ ¼è¢«ç‚¹å¼€åçš„æ‰©æ•£å…‰æ™• */
  .cell.flash::after{
    content:"";position:absolute;inset:-10%;border-radius:12px;
    background:radial-gradient(circle, rgba(56,189,248,.55) 0%, rgba(56,189,248,0) 60%);
    animation:flashGlow 1s ease-out forwards;
    pointer-events:none;
  }
  @keyframes flashGlow{
    0%{opacity:0;transform:scale(.8)}
    20%{opacity:1;transform:scale(1)}
    100%{opacity:0;transform:scale(1.3)}
  }

  .stats{
    display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:12px 16px;border-top:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.04);border-radius:0 0 16px 16px
  }
  .statLabel{font-size:12px;color:#bbf7d0}
  .statValue{font-size:18px;margin-top:6px}

  .log{padding:10px 16px;border-top:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);max-height:160px;overflow:auto;border-radius:0 0 16px 16px}
  .log p{margin:6px 0;color:#e5e7eb;font-size:13px}
</style>
</head>
<body>
<div class="app">
  <!-- å·¦ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
  <div class="card">
    <div class="panel">
      <h1>æ‰¾åœ°é›·ï½œå¯æ’¤é€€</h1>

      <div class="row">
        <div>
          <label>æ£‹ç›˜å¤§å°</label><br>
          <span class="selectWrap">
            <select id="boardSize" class="select">
              <option value="4">4 Ã— 4</option>
              <option value="5">5 Ã— 5</option>
              <option value="6">6 Ã— 6</option>
              <option value="8" selected>8 Ã— 8</option>
            </select>
          </span>
        </div>

        <div>
          <label>åœ°é›·æ•°é‡</label><br>
          <div class="stepper">
            <button id="mineMinus" type="button">âˆ’</button>
            <input id="mineCount" class="num" type="number" value="10" min="1" step="1">
            <button id="minePlus" type="button">+</button>
          </div>
        </div>

        <div>
          <label>ä¸‹æ³¨é‡‘é¢</label><br>
          <input id="betAmount" class="money" type="number" value="10" min="1" step="1">
        </div>
      </div>

      <div class="row">
        <button id="startResetBtn" class="btn btn-primary">å¼€å§‹æ¸¸æˆ</button>
        <button id="cashoutBtn" class="btn btn-gold" disabled>æ’¤é€€å¹¶ç»“ç®—</button>
      </div>

      <div class="row" style="margin-top:4px">
        <small>æ’¤é€€å¥–é‡‘ = ä¸‹æ³¨ Ã— 0.97 Ã· å½“å‰â€œä¸‹ä¸€æ ¼å®‰å…¨æ¦‚ç‡â€ã€‚</small>
      </div>
    </div>

    <div class="stats">
      <div>
        <div class="statLabel">å·²å®‰å…¨ç‚¹å‡»</div>
        <div class="statValue" id="safeClicks">0</div>
      </div>
      <div>
        <div class="statLabel">ä¸‹ä¸€æ ¼å®‰å…¨æ¦‚ç‡</div>
        <div class="statValue" id="nextProb">â€”</div>
      </div>
      <div>
        <div class="statLabel">å¯æ’¤é€€å¥–é‡‘</div>
        <div class="statValue" id="cashoutValue">â€”</div>
      </div>
    </div>

    <div class="balance">
      <div>ä½™é¢</div>
      <div style="display:flex;align-items:center;gap:8px">
        <strong id="balanceText">1000.00</strong>
        <button id="add100" class="btn-icon" title="+100">+</button>
      </div>
    </div>

    <div class="log" id="log"></div>
  </div>

  <!-- å³ä¾§ï¼šæ£‹ç›˜ -->
  <div class="card gridWrap">
    <div id="grid" class="grid"></div>
  </div>
</div>

<script>
(function(){
  // ------- çŠ¶æ€ -------
  let N=8, M=10;
  let mines=new Set(), revealed=new Set();
  let gameActive=false, exploded=false;
  let bet=10, balance=1000;

  // ------- DOM -------
  const gridEl=document.getElementById('grid');
  const boardSizeEl=document.getElementById('boardSize');
  const mineCountEl=document.getElementById('mineCount');
  const mineMinusBtn=document.getElementById('mineMinus');
  const minePlusBtn=document.getElementById('minePlus');
  const betAmountEl=document.getElementById('betAmount');
  const startResetBtn=document.getElementById('startResetBtn');
  const cashoutBtn=document.getElementById('cashoutBtn');
  const safeClicksEl=document.getElementById('safeClicks');
  const nextProbEl=document.getElementById('nextProb');
  const cashoutValueEl=document.getElementById('cashoutValue');
  const balanceText=document.getElementById('balanceText');
  const add100Btn=document.getElementById('add100');
  const logEl=document.getElementById('log');

  // ------- å·¥å…· -------
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const formatMoney=x=>(+x).toFixed(2);
  const log=msg=>{const p=document.createElement('p');p.textContent=msg;logEl.prepend(p);while(logEl.children.length>60)logEl.removeChild(logEl.lastChild);};

  function updateHUD(){
    const total=N*N, opened=revealed.size;
    const remainCells=total-opened, remainSafe=(total-M)-opened;

    if(gameActive && !exploded){
      const nextP=remainCells>0?remainSafe/remainCells:0;
      nextProbEl.textContent = (nextP*100).toFixed(2)+'%';
      if(opened>0 && nextP>0){
        cashoutValueEl.textContent = formatMoney(bet*0.97/nextP);
        cashoutBtn.disabled=false;
      }else{
        cashoutValueEl.textContent='â€”';
        cashoutBtn.disabled=true;
      }
    }else{
      nextProbEl.textContent='â€”';
      cashoutValueEl.textContent='â€”';
      cashoutBtn.disabled=true;
    }

    safeClicksEl.textContent = revealed.size;
    balanceText.textContent = formatMoney(balance);

    // åŒæ­¥åœ°é›·æ•°è¾“å…¥åŒºé—´
    mineCountEl.min = 1;
    mineCountEl.max = Math.max(1, N*N - 1);
  }

  function buildGrid(){
    gridEl.innerHTML='';
    gridEl.style.gridTemplateColumns=`repeat(${N},52px)`;
    for(let i=0;i<N*N;i++){
      const c=document.createElement('div');
      c.className='cell';c.dataset.idx=i;
      c.addEventListener('click',onCellClick);
      gridEl.appendChild(c);
    }
  }

  function placeMines(){
    mines.clear();
    while(mines.size<M) mines.add(Math.floor(Math.random()*N*N));
  }

  // ä¸æ˜¾ç¤ºæ•°å­—ï¼šåªåš reveal + åŠ¨æ•ˆ
  function reveal(idx){
    if(revealed.has(idx)) return;
    revealed.add(idx);
    const el=gridEl.children[idx];
    el.classList.add('revealed','flash');              // æ·»åŠ å…‰æ™•åŠ¨ç”»
    el.addEventListener('animationend',()=>{           // åŠ¨ç”»ç»“æŸç§»é™¤ class
      el.classList.remove('flash');
    },{once:true});
  }
  function revealAllMines(){
    mines.forEach(i=>{
      const el=gridEl.children[i];
      el.classList.add('revealed','mine');
      el.textContent='ğŸ’£';
    });
  }

  function onCellClick(e){
    if(!gameActive || exploded) return;
    const idx=+e.currentTarget.dataset.idx;
    if(revealed.has(idx)) return;

    // ç‚¹å‡»å‰çš„â€œå½“ç›˜æ¦‚ç‡â€ï¼ˆç”¨äºå…¨æ¸…ç»“ç®—ï¼‰
    const total=N*N, opened=revealed.size;
    const remainCells=total-opened, remainSafe=(total-M)-opened;
    const pBefore = remainCells>0 ? (remainSafe/remainCells) : 0;
    const payoutIfWin = pBefore>0 ? bet*0.97/pBefore : 0;

    if(mines.has(idx)){
      exploded=true; revealAllMines();
      e.currentTarget.classList.add('mine'); e.currentTarget.textContent='ğŸ’¥';
      log(`ğŸ’¥ è§¦é›·ï¼ŒæŸå¤± ${formatMoney(bet)}`);
      gameActive=false; startResetBtn.textContent='å¼€å§‹æ¸¸æˆ';
      updateHUD(); return;
    }

    reveal(idx);

    // èƒœåˆ©ï¼ˆæ‰€æœ‰å®‰å…¨æ ¼éƒ½å¼€å®Œï¼‰
    if(revealed.size >= total - M){
      balance += payoutIfWin;
      log(`ğŸ† å…¨æ¸…ï¼Œè·å¾— ${formatMoney(payoutIfWin)}ï¼ˆæŒ‰æœ€åä¸€æ¬¡ç‚¹å‡»å‰çš„å½“ç›˜æ¦‚ç‡ï¼‰`);
      gameActive=false; revealAllMines(); startResetBtn.textContent='å¼€å§‹æ¸¸æˆ';
      updateHUD(); return;
    }

    updateHUD();
  }

  // ------- äº¤äº’ -------
  function validateSettings(){
    N = parseInt(boardSizeEl.value,10) || 8;
    let m = parseInt(mineCountEl.value,10);
    m = clamp(isNaN(m)?1:m, 1, N*N - 1);
    M = m; mineCountEl.value = m;

    let b = parseFloat(betAmountEl.value);
    if(isNaN(b)||b<=0) b=1;
    bet = Math.floor(b*100)/100; betAmountEl.value=bet;
  }

  function resetBoardUI(keepMines=false){
    if(!keepMines){ mines.clear(); }
    revealed.clear(); exploded=false; gameActive=false;
    buildGrid(); updateHUD();
  }

  startResetBtn.addEventListener('click', ()=>{
    if(gameActive){
      // é‡å¼€
      resetBoardUI(false);
      startResetBtn.textContent='å¼€å§‹æ¸¸æˆ';
      log('ğŸ”„ å·²é‡ç½®æœ¬å±€ï¼ˆä¸å½±å“ä½™é¢ï¼‰');
      return;
    }
    // å¼€å§‹
    validateSettings();
    if(bet > balance){ log('âš ï¸ ä½™é¢ä¸è¶³ï¼Œè¯·å…ˆåŠ é’±æˆ–é™ä½ä¸‹æ³¨'); return; }
    balance -= bet;
    resetBoardUI(false);
    validateSettings();
    placeMines();
    gameActive=true;
    startResetBtn.textContent='é‡å¼€æ¸¸æˆ';
    log(`ğŸ® æ–°å±€ï¼š${N}Ã—${N}ï¼Œé›· ${M}ï¼Œä¸‹æ³¨ ${formatMoney(bet)}ï¼ˆå·²æ‰£æ¬¾ï¼‰`);
    updateHUD();
  });

  cashoutBtn.addEventListener('click', ()=>{
    if(!gameActive || exploded) return;
    const total=N*N, opened=revealed.size;
    if(opened<=0){ log('â„¹ï¸ å°šæœªç‚¹å‡»å®‰å…¨æ ¼ï¼Œæ— æ³•æ’¤é€€ç»“ç®—'); return; }
    const remainCells=total-opened, remainSafe=(total-M)-opened;
    if(remainCells<=0 || remainSafe<=0){ log('â„¹ï¸ å½“å‰æ— æ³•æŒ‰å½“ç›˜æ¦‚ç‡ç»“ç®—'); return; }
    const p = remainSafe/remainCells;
    const payout = bet*0.97/p;
    balance += payout;
    log(`ğŸ’° æ’¤é€€è·å¾— ${formatMoney(payout)}ï¼ˆå½“å‰å®‰å…¨æ¦‚ç‡ ${(p*100).toFixed(2)}%ï¼‰`);
    gameActive=false; revealAllMines(); startResetBtn.textContent='å¼€å§‹æ¸¸æˆ';
    updateHUD();
  });

  // æ£‹ç›˜å¤§å°å˜åŒ–
  boardSizeEl.addEventListener('change', ()=>{
    validateSettings(); resetBoardUI(false);
    log(`ğŸ§© æ£‹ç›˜åˆ‡æ¢ä¸º ${N}Ã—${N}ï¼Œè¯·è®¾ç½®é›·æ•°ä¸ä¸‹æ³¨åå¼€å§‹`);
  });

  // åœ°é›·æ•°ï¼šè¾“å…¥æ¡†ç›´æ¥æ”¹
  mineCountEl.addEventListener('change', ()=>{
    if(gameActive){
      mineCountEl.value = M; // è¿›è¡Œä¸­ä¸å…è®¸æ”¹
      log('âš ï¸ æœ¬å±€è¿›è¡Œä¸­ï¼Œæ— æ³•ä¿®æ”¹åœ°é›·æ•°');
      return;
    }
    validateSettings();
    resetBoardUI(false);
    log(`ğŸ§¨ åœ°é›·æ•°é‡è®¾ä¸º ${M}`);
  });

  // åœ°é›·æ•°ï¼šå‡æŒ‰é’®
  mineMinusBtn.addEventListener('click', ()=>{
    if(gameActive){ log('âš ï¸ æœ¬å±€è¿›è¡Œä¸­ï¼Œæ— æ³•ä¿®æ”¹åœ°é›·æ•°'); return; }
    validateSettings();
    mineCountEl.value = clamp(parseInt(mineCountEl.value,10)-1, 1, N*N-1);
    validateSettings(); resetBoardUI(false);
    log(`ğŸ§¨ åœ°é›·æ•°é‡è®¾ä¸º ${M}`);
  });

  // åœ°é›·æ•°ï¼šåŠ æŒ‰é’®
  minePlusBtn.addEventListener('click', ()=>{
    if(gameActive){ log('âš ï¸ æœ¬å±€è¿›è¡Œä¸­ï¼Œæ— æ³•ä¿®æ”¹åœ°é›·æ•°'); return; }
    validateSettings();
    mineCountEl.value = clamp(parseInt(mineCountEl.value,10)+1, 1, N*N-1);
    validateSettings(); resetBoardUI(false);
    log(`ğŸ§¨ åœ°é›·æ•°é‡è®¾ä¸º ${M}`);
  });

  // ä¸‹æ³¨é‡‘é¢
  betAmountEl.addEventListener('change', ()=>{
    validateSettings();
    if(gameActive){
      log('â„¹ï¸ æœ¬å±€ä¸‹æ³¨å·²é”å®šï¼Œä¿®æ”¹å°†åœ¨ä¸‹ä¸€å±€ç”Ÿæ•ˆ');
    }else{
      log(`ğŸ’µ ä¸‹æ³¨é‡‘é¢è®¾ä¸º ${formatMoney(bet)}`);
    }
  });

  // ä½™é¢ +100
  add100Btn.addEventListener('click', ()=>{
    balance += 100; updateHUD(); log('ğŸ’³ ä½™é¢ +100');
  });

  // åˆå§‹
  validateSettings(); buildGrid(); updateHUD();
})();
</script>
</body>
</html>
