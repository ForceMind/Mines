<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>æ‰¾åœ°é›·ï½œå¯æ’¤é€€ç‰ˆ</title>
<style>
  :root{
    --bg:#0f172a;
    --panel:#111827;
    --accent:#22c55e;
    --warn:#ef4444;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --btn:#1f2937;
    --btn2:#334155;
    --grid:#0b1220;
    --safe:#0ea5e9;
    --mine:#ef4444;
    --gold:#fbbf24;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:linear-gradient(180deg,#0b1220,#0f172a 40%,#0b1220);
    color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
    min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;
  }
  .app{width:100%;max-width:1100px;display:grid;grid-template-columns:340px 1fr;gap:16px}
  @media (max-width:900px){.app{grid-template-columns:1fr}}
  .card{
    background:linear-gradient(180deg,#0f172a,#0b1220);
    border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .panel{padding:16px 16px 12px}
  h1{margin:0 0 12px;font-size:20px;letter-spacing:.2px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
  label{font-size:12px;color:var(--muted)}
  select,input{background:var(--btn2);border:1px solid #263244;color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
  input[type="number"]{width:120px}
  .btn{background:var(--btn);border:1px solid #253244;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;transition:.15s;
       user-select:none}
  .btn:hover{transform:translateY(-1px)}
  .btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
  .btn-primary{background:linear-gradient(180deg,#16a34a,#15803d);border-color:#14532d}
  .btn-danger{background:linear-gradient(180deg,#dc2626,#b91c1c);border-color:#7f1d1d}
  .btn-gold{background:linear-gradient(180deg,#fbbf24,#f59e0b);border-color:#b45309;color:#1f2937}
  .balance{
    display:flex;justify-content:space-between;align-items:center;background:#0b1220;border-top:1px solid #1f2937;padding:12px 16px;border-radius:0 0 16px 16px
  }
  .balance strong{color:var(--gold);font-size:18px}
  .gridWrap{padding:16px}
  .grid{
    display:grid;gap:8px;justify-content:center;align-content:center;padding:12px;background:#0a1020;border-radius:12px;border:1px solid #1f2937;
    min-height:420px
  }
  .cell{
    width:52px;height:52px;display:flex;align-items:center;justify-content:center;
    background:radial-gradient(100% 100% at 50% 0%, #1c2738 0%, #121a28 100%);
    border:1px solid #223048;border-radius:10px;cursor:pointer;user-select:none;
    font-weight:700;font-size:16px;color:#93c5fd;box-shadow:inset 0 1px 0 rgba(255,255,255,.05), 0 6px 14px rgba(0,0,0,.25);
    transition:transform .08s ease, background .2s, border-color .2s;
  }
  .cell:hover{transform:translateY(-2px)}
  .cell.revealed{cursor:default;background:#0d1524;border-color:#1e293b;color:#60a5fa}
  .cell.mine{background:#2a0f13;border-color:#7f1d1d;color:#fecaca}
  .stats{
    display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:12px 16px;border-top:1px solid #1f2937;background:#0b1220;border-radius:0 0 16px 16px
  }
  .statBox{background:#0b162a;border:1px solid #1f2937;border-radius:12px;padding:10px}
  .statLabel{font-size:12px;color:var(--muted)}
  .statValue{font-size:18px;margin-top:6px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .log{padding:10px 16px;border-top:1px solid #1f2937;background:#0b1220;max-height:160px;overflow:auto;border-radius:0 0 16px 16px}
  .log p{margin:6px 0;color:#cbd5e1;font-size:13px}
  .tip{color:var(--muted);font-size:12px;margin-top:4px}
  .divider{height:1px;background:#1f2937;margin:10px 0}
</style>
</head>
<body>
<div class="app">
  <!-- å·¦ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
  <div class="card">
    <div class="panel">
      <h1>æ‰¾åœ°é›·ï½œå¯æ’¤é€€</h1>
      <div class="row">
        <div>
          <label>æ£‹ç›˜å¤§å°</label><br>
          <select id="boardSize">
            <option value="4">4 Ã— 4</option>
            <option value="5">5 Ã— 5</option>
            <option value="6">6 Ã— 6</option>
            <option value="8" selected>8 Ã— 8</option>
          </select>
        </div>
        <div>
          <label>åœ°é›·æ•°é‡</label><br>
          <input id="mineCount" type="number" value="10" min="1" step="1">
        </div>
        <div>
          <label>ä¸‹æ³¨é‡‘é¢</label><br>
          <input id="betAmount" type="number" value="10" min="1" step="1">
        </div>
      </div>
      <div class="toolbar">
        <button id="startBtn" class="btn btn-primary">å¼€å§‹æ¸¸æˆï¼ˆæ‰£æ¬¾ï¼‰</button>
        <button id="cashoutBtn" class="btn btn-gold" disabled>æ’¤é€€å¹¶ç»“ç®—</button>
        <button id="resetBtn" class="btn">æœ¬å±€é‡å¼€</button>
      </div>
      <div class="tip">è¯´æ˜ï¼šæ’¤é€€å¥–é‡‘ = ä¸‹æ³¨ Ã— <b>0.97</b> Ã— C(N, k) / C(Nâˆ’M, k)ã€‚N=æ€»æ ¼å­ï¼ŒM=é›·æ•°ï¼Œk=å·²æˆåŠŸç‚¹å¼€çš„å®‰å…¨æ ¼ã€‚</div>
    </div>
    <div class="stats">
      <div class="statBox">
        <div class="statLabel">å·²å®‰å…¨ç‚¹å‡» (k)</div>
        <div class="statValue" id="safeClicks">0</div>
      </div>
      <div class="statBox">
        <div class="statLabel">ä¸‹ä¸€æ ¼å®‰å…¨æ¦‚ç‡</div>
        <div class="statValue" id="nextProb">â€”</div>
      </div>
      <div class="statBox">
        <div class="statLabel">å½“å‰å¯æ’¤é€€å¥–é‡‘</div>
        <div class="statValue" id="cashoutValue">â€”</div>
      </div>
    </div>
    <div class="balance">
      <div>ä½™é¢</div>
      <div>
        <strong id="balanceText">1000.00</strong>
        <button id="add100" class="btn" style="margin-left:8px;">+100</button>
      </div>
    </div>
    <div class="log" id="log"></div>
  </div>

  <!-- å³ä¾§ï¼šæ£‹ç›˜ -->
  <div class="card gridWrap">
    <div id="grid" class="grid"></div>
  </div>
</div>

<script>
(function(){
  // ------- çŠ¶æ€ -------
  let N = 8, M = 10;                    // N*N æ€»æ ¼å­ï¼›M åœ°é›·æ•°
  let mines = new Set();                 // åœ°é›·ä½ç½®é›†åˆï¼ˆç´¢å¼•ï¼‰
  let revealed = new Set();              // å·²æ­ç¤ºå®‰å…¨æ ¼ï¼ˆç´¢å¼•ï¼‰
  let gameActive = false;                // æ˜¯å¦è¿›è¡Œä¸­
  let exploded = false;                  // æ˜¯å¦å·²è§¦é›·
  let bet = 10;                          // æœ¬å±€ä¸‹æ³¨
  let balance = 1000;                    // ä½™é¢
  let gridEl = document.getElementById('grid');

  const boardSizeEl = document.getElementById('boardSize');
  const mineCountEl = document.getElementById('mineCount');
  const betAmountEl = document.getElementById('betAmount');
  const startBtn = document.getElementById('startBtn');
  const cashoutBtn = document.getElementById('cashoutBtn');
  const resetBtn = document.getElementById('resetBtn');
  const add100Btn = document.getElementById('add100');

  const safeClicksEl = document.getElementById('safeClicks');
  const nextProbEl = document.getElementById('nextProb');
  const cashoutValueEl = document.getElementById('cashoutValue');
  const balanceText = document.getElementById('balanceText');
  const logEl = document.getElementById('log');

  // ------- å·¥å…·å‡½æ•° -------
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  // ç»„åˆæ•° C(n,k) ä½¿ç”¨ä¹˜æ³•å½¢å¼é¿å…æº¢å‡º/ç²¾åº¦æŸå¤±ï¼ˆn<=64 å®‰å…¨ï¼‰
  function comb(n,k){
    if(k<0||k>n) return 0;
    if(k===0||k===n) return 1;
    k = Math.min(k, n-k);
    let num = 1, den = 1;
    for(let i=1;i<=k;i++){
      num *= (n - k + i);
      den *= i;
    }
    return num/den;
  }

  // å…¬å¹³èµ”ç‡ï¼ˆç”Ÿå­˜ k æ­¥å¹¶æ’¤é€€ï¼‰ï¼šmult = C(N,k)/C(Nâˆ’M,k)ï¼›æŠ½æ°´ 3%
  function fairMultiplier(N,M,k){
    if(k===0) return 1; // æœªç‚¹å‡»æ’¤é€€=è¿”è¿˜æœ¬é‡‘ï¼ˆä½†æˆ‘ä»¬ UI ä¸å…è®¸ï¼‰
    const top = comb(N, k);
    const bottom = comb(N - M, k);
    if(bottom<=0) return 0;
    return top / bottom;
  }

  function formatMoney(x){ return (+x).toFixed(2); }

  function log(msg){
    const p = document.createElement('p');
    p.textContent = msg;
    logEl.prepend(p);
    // ä¿æŒæœ€å¤š 60 è¡Œ
    while(logEl.children.length>60){ logEl.removeChild(logEl.lastChild); }
  }

  function updateHUD(){
    const k = revealed.size;
    safeClicksEl.textContent = k;

    const total = N*N;
    const opened = revealed.size; // åªç»Ÿè®¡å®‰å…¨æ ¼ï¼›é›·æœªç‚¹å¼€
    const remainCells = total - opened - (exploded?1:0); // è‹¥å·²çˆ†ç‚¸ï¼Œè¿™ä¸ªå€¼æ— æ„ä¹‰
    const remainSafe = (total - M) - opened;

    if(gameActive && !exploded){
      const nextP = remainCells>0 ? remainSafe / remainCells : 0;
      nextProbEl.textContent = (nextP*100).toFixed(2) + '%';
      const mult = fairMultiplier(total, M, k);
      const cash = k>0 ? bet * 0.97 * mult : 0;
      cashoutValueEl.textContent = k>0 ? formatMoney(cash) : 'â€”';
      cashoutBtn.disabled = (k===0);
    }else{
      nextProbEl.textContent = 'â€”';
      cashoutValueEl.textContent = 'â€”';
      cashoutBtn.disabled = true;
    }

    balanceText.textContent = formatMoney(balance);
  }

  function buildGrid(){
    gridEl.innerHTML = '';
    gridEl.style.gridTemplateColumns = `repeat(${N}, minmax(40px, 52px))`;
    gridEl.style.minHeight = (N<8?380:420)+'px';

    for(let i=0;i<N*N;i++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.idx = i;
      cell.addEventListener('click', onCellClick, {once:false});
      gridEl.appendChild(cell);
    }
  }

  function placeMines(){
    mines.clear();
    const total = N*N;
    // éšæœºæ”¾ç½® M ä¸ªä¸åŒç´¢å¼•
    while(mines.size < M){
      mines.add(Math.floor(Math.random()*total));
    }
  }

  function neighbors(idx){
    const x = idx % N, y = Math.floor(idx/N);
    const res=[];
    for(let dy=-1;dy<=1;dy++){
      for(let dx=-1;dx<=1;dx++){
        if(dx===0 && dy===0) continue;
        const nx=x+dx, ny=y+dy;
        if(nx>=0 && nx<N && ny>=0 && ny<N){
          res.push(ny*N + nx);
        }
      }
    }
    return res;
  }

  function countAdjMines(idx){
    return neighbors(idx).reduce((acc,i)=>acc + (mines.has(i)?1:0), 0);
  }

  function reveal(idx){
    if(revealed.has(idx)) return;
    const el = gridEl.children[idx];
    if(!el) return;
    revealed.add(idx);
    const n = countAdjMines(idx);
    el.classList.add('revealed');
    el.textContent = n>0 ? n : '';
    el.style.color = n===0 ? '#93c5fd' : '#60a5fa';
  }

  function revealAllMines(){
    mines.forEach(i=>{
      const el = gridEl.children[i];
      if(el){
        el.classList.add('revealed','mine');
        el.textContent = 'ğŸ’£';
      }
    });
  }

  function onCellClick(e){
    if(!gameActive || exploded) return;
    const idx = +e.currentTarget.dataset.idx;
    // å·²æ­ç¤ºçš„ä¸å¤„ç†
    if(revealed.has(idx)) return;

    if(mines.has(idx)){
      // è§¦é›·
      exploded = true;
      revealAllMines();
      e.currentTarget.classList.add('mine');
      e.currentTarget.textContent = 'ğŸ’¥';
      log(`ğŸ’¥ è§¦å‘åœ°é›·ï¼æœ¬å±€å¤±å» ${formatMoney(bet)}ã€‚`);
      gameActive = false;
      updateHUD();
      return;
    }

    // å®‰å…¨
    reveal(idx);
    // è‹¥ç©ºç™½å¯æ‰©æ•£ï¼Œä¹Ÿå¯ä»¥åšé€’å½’å±•å¼€ï¼ˆè¿™é‡Œä¿æŒè°¨æ…ï¼šåªå•å‡»æ­ç¤ºï¼‰
    const n = countAdjMines(idx);
    if(n===0){
      // å¯é€‰æ‹©â€œè½»åº¦è‡ªåŠ¨å±•å¼€â€â€”â€”å±•å¼€å…¶å‘¨å›´éé›·æœªç‚¹å¼€çš„ 0 é‚»é›·æ ¼
      neighbors(idx).forEach(j=>{
        if(!mines.has(j) && !revealed.has(j) && countAdjMines(j)===0){
          reveal(j);
        }
      });
    }

    // èƒœåˆ©æ¡ä»¶ï¼ˆå…¨éƒ¨å®‰å…¨æ ¼å¼€å®Œï¼‰
    const totalSafe = N*N - M;
    if(revealed.size >= totalSafe){
      const k = revealed.size;
      const mult = fairMultiplier(N*N, M, k);
      const payout = bet * 0.97 * mult; // k=totalSafe çš„æƒ…å†µ
      balance += payout;
      log(`ğŸ† å…¨éƒ¨å®‰å…¨æ ¼å·²æ­ç¤ºï¼è‡ªåŠ¨æŒ‰æ’¤é€€ç»“ç®—ï¼Œè·å¾— ${formatMoney(payout)}ã€‚`);
      gameActive = false;
      revealAllMines(); // å±•ç¤ºå…¨å›¾ï¼ˆå…¶å®æ²¡æœ‰æœªæ­ç¤ºå®‰å…¨æ ¼äº†ï¼‰
    }

    updateHUD();
  }

  // ------- äº¤äº’ -------
  function validateSettings(){
    N = parseInt(boardSizeEl.value, 10);
    const total = N*N;
    let m = parseInt(mineCountEl.value, 10);
    if(Number.isNaN(m)) m = 1;
    m = clamp(m, 1, total-1);
    mineCountEl.value = m;
    M = m;

    let b = parseFloat(betAmountEl.value);
    if(Number.isNaN(b) || b<=0) b = 1;
    b = Math.floor(b*100)/100;
    betAmountEl.value = b;
    bet = b;
  }

  function resetRound(keepBalance=true){
    gameActive = false;
    exploded = false;
    mines.clear();
    revealed.clear();
    if(!keepBalance){ balance = 1000; }
    buildGrid();
    updateHUD();
  }

  startBtn.addEventListener('click', ()=>{
    if(gameActive){
      log('âš ï¸ æœ¬å±€å·²åœ¨è¿›è¡Œä¸­ã€‚');
      return;
    }
    validateSettings();
    if(bet > balance){
      log('âš ï¸ ä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼æˆ–é™ä½ä¸‹æ³¨é‡‘é¢ã€‚');
      return;
    }
    balance -= bet;
    resetRound(true); // æ¸…ç©ºæ£‹ç›˜ä½†ä¿ç•™ä½™é¢å˜åŒ–
    validateSettings(); // ç¡®ä¿ N/M ä¸è¾“å…¥ä¸€è‡´
    placeMines();
    gameActive = true;
    exploded = false;
    log(`ğŸ® å¼€å§‹æ–°å±€ï¼š${N}Ã—${N}ï¼Œåœ°é›· ${M}ï¼Œä¸‹æ³¨ ${formatMoney(bet)}ï¼ˆå·²æ‰£æ¬¾ï¼‰ã€‚ç¥ä½ å¥½è¿ï¼`);
    updateHUD();
  });

  cashoutBtn.addEventListener('click', ()=>{
    if(!gameActive || exploded) return;
    const k = revealed.size;
    if(k<=0){
      log('â„¹ï¸ å°šæœªç‚¹å‡»å®‰å…¨æ ¼ï¼Œæ— æ³•æ’¤é€€ç»“ç®—ã€‚');
      return;
    }
    const mult = fairMultiplier(N*N, M, k);
    const payout = bet * 0.97 * mult;
    balance += payout;
    log(`ğŸ’° æ’¤é€€æˆåŠŸï¼šå®‰å…¨ç‚¹å‡» ${k} æ ¼ï¼Œèµ”ç‡ Ã—${mult.toFixed(4)}ï¼Œåˆ°æ‰‹ ${formatMoney(payout)}ã€‚`);
    gameActive = false;
    revealAllMines();
    updateHUD();
  });

  resetBtn.addEventListener('click', ()=>{
    resetRound(true);
    log('ğŸ”„ æœ¬å±€å·²é‡ç½®ï¼ˆä¸å½±å“ä½™é¢ï¼‰ã€‚');
  });

  add100Btn.addEventListener('click', ()=>{
    balance += 100;
    updateHUD();
    log('ğŸ’³ å·²å……å€¼ +100ã€‚');
  });

  boardSizeEl.addEventListener('change', ()=>{
    validateSettings();
    resetRound(true);
    log(`ğŸ§© æ£‹ç›˜åˆ‡æ¢ä¸º ${N}Ã—${N}ï¼Œè¯·è®¾ç½®åœ°é›·ä¸ä¸‹æ³¨åå¼€å§‹ã€‚`);
  });

  mineCountEl.addEventListener('change', ()=>{
    validateSettings();
    if(gameActive){
      log('âš ï¸ è¿›è¡Œä¸­çš„å¯¹å±€æ— æ³•ä¿®æ”¹åœ°é›·æ•°ã€‚è¯·é‡å¼€æœ¬å±€ã€‚');
      mineCountEl.value = M;
      return;
    }
    resetRound(true);
    log(`ğŸ§¨ åœ°é›·æ•°é‡å·²è®¾ä¸º ${M}ã€‚`);
  });

  betAmountEl.addEventListener('change', ()=>{
    validateSettings();
    if(gameActive){
      log('â„¹ï¸ æœ¬å±€ä¸‹æ³¨å·²ç”Ÿæ•ˆï¼Œä¿®æ”¹å°†åœ¨ä¸‹ä¸€å±€å¼€å§‹æ—¶ç”Ÿæ•ˆã€‚');
    }else{
      log(`ğŸ’µ ä¸‹æ³¨é‡‘é¢è®¾ä¸º ${formatMoney(bet)}ã€‚`);
    }
  });

  // åˆå§‹
  validateSettings();
  resetRound(true);
  log('ğŸ“Œ è§„åˆ™ï¼šç‚¹å‡»å®‰å…¨æ ¼å¯ç»§ç»­ï¼Œåœ¨æœªè§¦é›·æ—¶éšæ—¶â€œæ’¤é€€å¹¶ç»“ç®—â€ã€‚èµ”ç‡æŒ‰ç»„åˆæ•°å­¦è®¡ç®—ï¼ŒæŠ½æ°´ 3%ã€‚');

})();
</script>
</body>
</html>
