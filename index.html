<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>找地雷｜可撤退版</title>
<style>
  :root{
    --bg1:#0e1f3a; --bg2:#15365f; --panel:#102747; --panel2:#16385f;
    --accent:#22d3ee; --warn:#f87171; --text:#f3f4f6; --muted:#c7d2fe;
    --btn:#1e3a8a; --btn2:#25469e; --safe:#38bdf8; --mine:#ef4444; --gold:#fde68a;
    --ink:#0f172a; --ink2:#1f2937;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2) 50%,var(--bg1));
    color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
    min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;
  }
  .app{width:100%;max-width:1100px;display:grid;grid-template-columns:340px 1fr;gap:16px}
  @media (max-width:900px){.app{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .panel{padding:16px 16px 12px}
  h1{margin:0 0 12px;font-size:20px;letter-spacing:.2px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
  label{font-size:12px;color:var(--gold)}

  /* —— 输入控件（浅底深字） —— */
  .select, .num, .money{
    background:#ffffff;color:var(--ink);border:1px solid #cbd5e1;border-radius:10px;
    padding:10px 12px;outline:none;
  }
  .select{appearance:none;position:relative;padding-right:34px;min-width:120px}
  .selectWrap{position:relative;display:inline-block}
  .selectWrap::after{
    content:"▾";position:absolute;right:10px;top:50%;transform:translateY(-50%);
    color:var(--ink2);pointer-events:none;font-size:12px;
  }
  .num{width:110px;text-align:center}
  .money{width:120px}

  .stepper{
    display:inline-flex;align-items:center;border-radius:10px;overflow:hidden;border:1px solid #cbd5e1;background:#fff;
  }
  .stepper button{
    background:#f1f5f9;border:none;padding:10px 12px;cursor:pointer;font-weight:700;color:var(--ink2);
    transition:transform .06s ease, filter .06s ease;
  }
  .stepper button:hover{filter:brightness(0.95)}
  .stepper button:active{transform:translateY(1px)}
  .stepper input{border:none;border-left:1px solid #e5e7eb;border-right:1px solid #e5e7eb}

  /* —— 按钮动效 —— */
  .btn{
    background:var(--btn);border:1px solid rgba(255,255,255,.2);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;
    transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
    user-select:none;box-shadow:0 6px 14px rgba(30,58,138,.35)
  }
  .btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(30,58,138,.45)}
  .btn:active{transform:translateY(0);filter:brightness(0.95)}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}
  .btn-primary{background:linear-gradient(180deg,#1fb6ff,#1d4ed8)}
  .btn-gold{background:linear-gradient(180deg,#fde68a,#f59e0b);color:#1f2937}
  .btn-icon{
    width:36px;height:36px;border-radius:999px;border:1px solid rgba(255,255,255,.25);
    background:linear-gradient(180deg,#fef3c7,#fde68a);color:#1f2937;font-weight:900;cursor:pointer;
    transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
  }
  .btn-icon:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,.25)}
  .btn-icon:active{transform:translateY(0);filter:brightness(0.95)}

  .balance{
    display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.04);
    border-top:1px solid rgba(255,255,255,.12);padding:12px 16px;border-radius:0 0 16px 16px
  }
  .balance strong{color:var(--gold);font-size:18px;text-shadow:0 0 8px rgba(253,230,138,.35)}

  .gridWrap{padding:16px}
  .grid{
    display:grid;gap:8px;justify-content:center;align-content:center;padding:12px;
    background:linear-gradient(180deg,#0b1d3a,#0f2b55);border-radius:12px;border:1px solid rgba(255,255,255,.12);
    min-height:420px
  }

  /* —— 棋盘格 + 动效 —— */
  .cell{
    width:52px;height:52px;display:flex;align-items:center;justify-content:center;
    background:radial-gradient(100% 100% at 50% 0%, #2a4f8c 0%, #1a3766 100%);
    border:1px solid rgba(255,255,255,.18);border-radius:10px;cursor:pointer;user-select:none;
    transition:transform .08s ease, background .2s, border-color .2s, box-shadow .2s;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.15), 0 6px 14px rgba(0,0,0,.25);
    position:relative;overflow:hidden;
  }
  .cell:hover{transform:translateY(-2px)}
  .cell:active{transform:translateY(0);filter:brightness(0.98)}
  .cell.revealed{cursor:default;background:#19406f;border-color:rgba(255,255,255,.3)}
  .cell.mine{background:#7f1d1d;border-color:#fecaca;color:#fecaca}

  /* 安全格被点开后的扩散光晕 */
  .cell.flash::after{
    content:"";position:absolute;inset:-10%;border-radius:12px;
    background:radial-gradient(circle, rgba(56,189,248,.55) 0%, rgba(56,189,248,0) 60%);
    animation:flashGlow 1s ease-out forwards;
    pointer-events:none;
  }
  @keyframes flashGlow{
    0%{opacity:0;transform:scale(.8)}
    20%{opacity:1;transform:scale(1)}
    100%{opacity:0;transform:scale(1.3)}
  }

  .stats{
    display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:12px 16px;border-top:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.04);border-radius:0 0 16px 16px
  }
  .statLabel{font-size:12px;color:#bbf7d0}
  .statValue{font-size:18px;margin-top:6px}

  .log{padding:10px 16px;border-top:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);max-height:160px;overflow:auto;border-radius:0 0 16px 16px}
  .log p{margin:6px 0;color:#e5e7eb;font-size:13px}
</style>
</head>
<body>
<div class="app">
  <!-- 左侧：控制面板 -->
  <div class="card">
    <div class="panel">
      <h1>找地雷｜可撤退</h1>

      <div class="row">
        <div>
          <label>棋盘大小</label><br>
          <span class="selectWrap">
            <select id="boardSize" class="select">
              <option value="4">4 × 4</option>
              <option value="5">5 × 5</option>
              <option value="6">6 × 6</option>
              <option value="8" selected>8 × 8</option>
            </select>
          </span>
        </div>

        <div>
          <label>地雷数量</label><br>
          <div class="stepper">
            <button id="mineMinus" type="button">−</button>
            <input id="mineCount" class="num" type="number" value="10" min="1" step="1">
            <button id="minePlus" type="button">+</button>
          </div>
        </div>

        <div>
          <label>下注金额</label><br>
          <input id="betAmount" class="money" type="number" value="10" min="1" step="1">
        </div>
      </div>

      <div class="row">
        <button id="startResetBtn" class="btn btn-primary">开始游戏</button>
        <button id="cashoutBtn" class="btn btn-gold" disabled>撤退并结算</button>
      </div>

      <div class="row" style="margin-top:4px">
        <small>撤退奖金 = 下注 × 0.97 ÷ 当前“下一格安全概率”。</small>
      </div>
    </div>

    <div class="stats">
      <div>
        <div class="statLabel">已安全点击</div>
        <div class="statValue" id="safeClicks">0</div>
      </div>
      <div>
        <div class="statLabel">下一格安全概率</div>
        <div class="statValue" id="nextProb">—</div>
      </div>
      <div>
        <div class="statLabel">可撤退奖金</div>
        <div class="statValue" id="cashoutValue">—</div>
      </div>
    </div>

    <div class="balance">
      <div>余额</div>
      <div style="display:flex;align-items:center;gap:8px">
        <strong id="balanceText">1000.00</strong>
        <button id="add100" class="btn-icon" title="+100">+</button>
      </div>
    </div>

    <div class="log" id="log"></div>
  </div>

  <!-- 右侧：棋盘 -->
  <div class="card gridWrap">
    <div id="grid" class="grid"></div>
  </div>
</div>

<script>
(function(){
  // ------- 状态 -------
  let N=8, M=10;
  let mines=new Set(), revealed=new Set();
  let gameActive=false, exploded=false;
  let bet=10, balance=1000;

  // ------- DOM -------
  const gridEl=document.getElementById('grid');
  const boardSizeEl=document.getElementById('boardSize');
  const mineCountEl=document.getElementById('mineCount');
  const mineMinusBtn=document.getElementById('mineMinus');
  const minePlusBtn=document.getElementById('minePlus');
  const betAmountEl=document.getElementById('betAmount');
  const startResetBtn=document.getElementById('startResetBtn');
  const cashoutBtn=document.getElementById('cashoutBtn');
  const safeClicksEl=document.getElementById('safeClicks');
  const nextProbEl=document.getElementById('nextProb');
  const cashoutValueEl=document.getElementById('cashoutValue');
  const balanceText=document.getElementById('balanceText');
  const add100Btn=document.getElementById('add100');
  const logEl=document.getElementById('log');

  // ------- 工具 -------
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const formatMoney=x=>(+x).toFixed(2);
  const log=msg=>{const p=document.createElement('p');p.textContent=msg;logEl.prepend(p);while(logEl.children.length>60)logEl.removeChild(logEl.lastChild);};

  function updateHUD(){
    const total=N*N, opened=revealed.size;
    const remainCells=total-opened, remainSafe=(total-M)-opened;

    if(gameActive && !exploded){
      const nextP=remainCells>0?remainSafe/remainCells:0;
      nextProbEl.textContent = (nextP*100).toFixed(2)+'%';
      if(opened>0 && nextP>0){
        cashoutValueEl.textContent = formatMoney(bet*0.97/nextP);
        cashoutBtn.disabled=false;
      }else{
        cashoutValueEl.textContent='—';
        cashoutBtn.disabled=true;
      }
    }else{
      nextProbEl.textContent='—';
      cashoutValueEl.textContent='—';
      cashoutBtn.disabled=true;
    }

    safeClicksEl.textContent = revealed.size;
    balanceText.textContent = formatMoney(balance);

    // 同步地雷数输入区间
    mineCountEl.min = 1;
    mineCountEl.max = Math.max(1, N*N - 1);
  }

  function buildGrid(){
    gridEl.innerHTML='';
    gridEl.style.gridTemplateColumns=`repeat(${N},52px)`;
    for(let i=0;i<N*N;i++){
      const c=document.createElement('div');
      c.className='cell';c.dataset.idx=i;
      c.addEventListener('click',onCellClick);
      gridEl.appendChild(c);
    }
  }

  function placeMines(){
    mines.clear();
    while(mines.size<M) mines.add(Math.floor(Math.random()*N*N));
  }

  // 不显示数字：只做 reveal + 动效
  function reveal(idx){
    if(revealed.has(idx)) return;
    revealed.add(idx);
    const el=gridEl.children[idx];
    el.classList.add('revealed','flash');              // 添加光晕动画
    el.addEventListener('animationend',()=>{           // 动画结束移除 class
      el.classList.remove('flash');
    },{once:true});
  }
  function revealAllMines(){
    mines.forEach(i=>{
      const el=gridEl.children[i];
      el.classList.add('revealed','mine');
      el.textContent='💣';
    });
  }

  function onCellClick(e){
    if(!gameActive || exploded) return;
    const idx=+e.currentTarget.dataset.idx;
    if(revealed.has(idx)) return;

    // 点击前的“当盘概率”（用于全清结算）
    const total=N*N, opened=revealed.size;
    const remainCells=total-opened, remainSafe=(total-M)-opened;
    const pBefore = remainCells>0 ? (remainSafe/remainCells) : 0;
    const payoutIfWin = pBefore>0 ? bet*0.97/pBefore : 0;

    if(mines.has(idx)){
      exploded=true; revealAllMines();
      e.currentTarget.classList.add('mine'); e.currentTarget.textContent='💥';
      log(`💥 触雷，损失 ${formatMoney(bet)}`);
      gameActive=false; startResetBtn.textContent='开始游戏';
      updateHUD(); return;
    }

    reveal(idx);

    // 胜利（所有安全格都开完）
    if(revealed.size >= total - M){
      balance += payoutIfWin;
      log(`🏆 全清，获得 ${formatMoney(payoutIfWin)}（按最后一次点击前的当盘概率）`);
      gameActive=false; revealAllMines(); startResetBtn.textContent='开始游戏';
      updateHUD(); return;
    }

    updateHUD();
  }

  // ------- 交互 -------
  function validateSettings(){
    N = parseInt(boardSizeEl.value,10) || 8;
    let m = parseInt(mineCountEl.value,10);
    m = clamp(isNaN(m)?1:m, 1, N*N - 1);
    M = m; mineCountEl.value = m;

    let b = parseFloat(betAmountEl.value);
    if(isNaN(b)||b<=0) b=1;
    bet = Math.floor(b*100)/100; betAmountEl.value=bet;
  }

  function resetBoardUI(keepMines=false){
    if(!keepMines){ mines.clear(); }
    revealed.clear(); exploded=false; gameActive=false;
    buildGrid(); updateHUD();
  }

  startResetBtn.addEventListener('click', ()=>{
    if(gameActive){
      // 重开
      resetBoardUI(false);
      startResetBtn.textContent='开始游戏';
      log('🔄 已重置本局（不影响余额）');
      return;
    }
    // 开始
    validateSettings();
    if(bet > balance){ log('⚠️ 余额不足，请先加钱或降低下注'); return; }
    balance -= bet;
    resetBoardUI(false);
    validateSettings();
    placeMines();
    gameActive=true;
    startResetBtn.textContent='重开游戏';
    log(`🎮 新局：${N}×${N}，雷 ${M}，下注 ${formatMoney(bet)}（已扣款）`);
    updateHUD();
  });

  cashoutBtn.addEventListener('click', ()=>{
    if(!gameActive || exploded) return;
    const total=N*N, opened=revealed.size;
    if(opened<=0){ log('ℹ️ 尚未点击安全格，无法撤退结算'); return; }
    const remainCells=total-opened, remainSafe=(total-M)-opened;
    if(remainCells<=0 || remainSafe<=0){ log('ℹ️ 当前无法按当盘概率结算'); return; }
    const p = remainSafe/remainCells;
    const payout = bet*0.97/p;
    balance += payout;
    log(`💰 撤退获得 ${formatMoney(payout)}（当前安全概率 ${(p*100).toFixed(2)}%）`);
    gameActive=false; revealAllMines(); startResetBtn.textContent='开始游戏';
    updateHUD();
  });

  // 棋盘大小变化
  boardSizeEl.addEventListener('change', ()=>{
    validateSettings(); resetBoardUI(false);
    log(`🧩 棋盘切换为 ${N}×${N}，请设置雷数与下注后开始`);
  });

  // 地雷数：输入框直接改
  mineCountEl.addEventListener('change', ()=>{
    if(gameActive){
      mineCountEl.value = M; // 进行中不允许改
      log('⚠️ 本局进行中，无法修改地雷数');
      return;
    }
    validateSettings();
    resetBoardUI(false);
    log(`🧨 地雷数量设为 ${M}`);
  });

  // 地雷数：减按钮
  mineMinusBtn.addEventListener('click', ()=>{
    if(gameActive){ log('⚠️ 本局进行中，无法修改地雷数'); return; }
    validateSettings();
    mineCountEl.value = clamp(parseInt(mineCountEl.value,10)-1, 1, N*N-1);
    validateSettings(); resetBoardUI(false);
    log(`🧨 地雷数量设为 ${M}`);
  });

  // 地雷数：加按钮
  minePlusBtn.addEventListener('click', ()=>{
    if(gameActive){ log('⚠️ 本局进行中，无法修改地雷数'); return; }
    validateSettings();
    mineCountEl.value = clamp(parseInt(mineCountEl.value,10)+1, 1, N*N-1);
    validateSettings(); resetBoardUI(false);
    log(`🧨 地雷数量设为 ${M}`);
  });

  // 下注金额
  betAmountEl.addEventListener('change', ()=>{
    validateSettings();
    if(gameActive){
      log('ℹ️ 本局下注已锁定，修改将在下一局生效');
    }else{
      log(`💵 下注金额设为 ${formatMoney(bet)}`);
    }
  });

  // 余额 +100
  add100Btn.addEventListener('click', ()=>{
    balance += 100; updateHUD(); log('💳 余额 +100');
  });

  // 初始
  validateSettings(); buildGrid(); updateHUD();
})();
</script>
</body>
</html>
